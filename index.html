<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <link rel="stylesheet" href="style.css" />
        <title>API Practice</title>
    </head>
    <body>
        <div class="grid-container">
            <header class="row">
                <div>
                    <a class="brand" href="index.html">API Practice</a>
                </div>
                <div>
                    <a href="index.html">로그인</a>
                </div>
            </header>
            <main>
                <div class="row center">
                    <form id="form">
                        <input
                            type="text"
                            name="keyword"
                            id="keyword"
                            placeholder="검색어 입력"
                        />
                        <button type="submit">검색</button>
                    </form>
                    <ul id="address-list"></ul>
                </div>
            </main>
            <footer>&copy; 2018037010 <a href="https://github.com/dungbik">윤정환</a></footer>
        </div>
        <script>
            const API_URL =
                "http://www.juso.go.kr/addrlink/addrLinkApiJsonp.do";
            const API_KEY = "devU01TX0FVVEgyMDIwMTExOTIyNDYyMDExMDQ0MjM=";
            const form = document.querySelector("#form");
            const addressList = document.querySelector("#address-list");

            form.addEventListener("submit", async e => {
                e.preventDefault();
                const keyword = encodeURIComponent(form.keyword.value);
                try {
                    const response = await search(keyword);
                    const txt = await response.text();
                    const results = JSON.parse(
                        txt.replace(/^\(/, "").replace(/\)$/, "")
                    ).results;
                    display(results);
                    form.reset();
                } catch (e) {
                    console.error(e);
                }
            });
            function search(keyword, currentPage = 1, countPerPage = 10) {
                const data = {
                    confmKey: API_KEY,
                    keyword,
                    currentPage,
                    countPerPage,
                    resultType: "json"
                };

                const body = Object.keys(data)
                    .map(key => `${key}=${data[key]}`)
                    .join("&");

                const options = {
                    method: "POST",
                    body,
                    headers: {
                        "Content-Type":
                            "application/x-www-form-urlencoded;charset=UTF-8"
                    }
                };

                return fetch(API_URL, options);
            }

            function display(results) {
                addressList.innerHTML = "";
                results.juso.forEach(item => {
                    const li = document.createElement("li");
                    li.innerHTML = `${item.zipNo}) ${item.roadAddr}`;
                    addressList.appendChild(li);
                });
            }
        </script>
    </body>
</html>
