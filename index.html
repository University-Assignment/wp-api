<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <link rel="stylesheet" href="style.css" />
        <title>API Practice</title>
    </head>
    <body>
        <div class="grid-container">
            <header class="row">
                <div>
                    <a class="brand" href="index.html">API Practice</a>
                </div>
                <div>
                    <a href="index.html">로그인</a>
                </div>
            </header>
            <main>
                <div class="row center">
                    <form id="form">
                        <input type="hidden" name="currentPage" value="1" />
                        <input
                            type="text"
                            name="keyword"
                            id="keyword"
                            placeholder="검색어 입력"
                        />
                        <button type="submit">검색</button>
                    </form>
                    <ul id="address-list"></ul>
                    <div class="paginate" id="pageApi"></div>
                </div>
            </main>
            <footer>
                &copy; 2018037010
                <a href="https://github.com/dungbik">윤정환</a>
            </footer>
        </div>
        <script>
            const API_URL =
                "http://www.juso.go.kr/addrlink/addrLinkApiJsonp.do";
            const API_KEY = "devU01TX0FVVEgyMDIwMTExOTIyNDYyMDExMDQ0MjM=";
            const form = document.querySelector("#form");
            const addressList = document.querySelector("#address-list");

            form.addEventListener("submit", async e => {
                e.preventDefault();
                form.currentPage.value = 1;
                await changeInfo();
            });
            
            async function changeInfo() {
                const keyword = encodeURIComponent(form.keyword.value);
                try {
                    const response = await search(
                        keyword,
                        form.currentPage.value
                    );
                    const txt = await response.text();
                    const results = JSON.parse(
                        txt.replace(/^\(/, "").replace(/\)$/, "")
                    ).results;
                    pageMake(results);
                    display(results);
                } catch (e) {
                    console.error(e);
                }
            }
            
            function search(keyword, currentPage, countPerPage = 5) {
                const data = {
                    confmKey: API_KEY,
                    keyword,
                    currentPage,
                    countPerPage,
                    resultType: "json"
                };

                const body = Object.keys(data)
                    .map(key => `${key}=${data[key]}`)
                    .join("&");

                const options = {
                    method: "POST",
                    body,
                    headers: {
                        "Content-Type":
                            "application/x-www-form-urlencoded;charset=UTF-8"
                    }
                };

                return fetch(API_URL, options);
            }

            function display(results) {
                addressList.innerHTML = "";
                results.juso.forEach(item => {
                    const li = document.createElement("li");
                    li.innerHTML = `${item.zipNo}) ${item.roadAddr}`;
                    addressList.appendChild(li);
                });
            }

            async function goPage(pageNum) {
                form.currentPage.value = pageNum;
                await changeInfo();
            }

            function pageMake(jsonStr) {
                var total = jsonStr.common.totalCount;
                var pageNum = form.currentPage.value;
                var paggingStr = "<nav>";
                paggingStr += "<ul>";
                if (total < 1) {
                } else {
                    var PAGEBLOCK = 5;
                    var pageSize = 5;
                    var totalPages = Math.floor((total - 1) / pageSize) + 1;
                    var firstPage =
                        Math.floor((pageNum - 1) / PAGEBLOCK) * PAGEBLOCK + 1;
                    if (firstPage <= 0) firstPage = 1;
                    var lastPage = firstPage - 1 + PAGEBLOCK;
                    if (lastPage > totalPages) lastPage = totalPages;
                    var nextPage = lastPage + 1;
                    var prePage = firstPage - 5;
                    if (firstPage > PAGEBLOCK) {
                        paggingStr +=
                            "<a href='javascript:goPage(" +
                            prePage +
                            ");'>◁</a>  ";
                    }
                    for (i = firstPage; i <= lastPage; i++) {
                        if (pageNum == i)
                            paggingStr +=
                                "<a href='javascript:goPage(" +
                                i +
                                ");'>" +
                                i +
                                "</a>";
                        else
                            paggingStr +=
                                "<a href='javascript:goPage(" +
                                i +
                                ");'>" +
                                i +
                                "</a>";
                    }
                    if (lastPage < totalPages) {
                        paggingStr +=
                            "<a href='javascript:goPage(" +
                            nextPage +
                            ");'>▷</a>";
                    }
                    paggingStr += "</ul>";
                    paggingStr += "</nav>";
                    document.querySelector("#pageApi").innerHTML = paggingStr;
                }
            }
        </script>
    </body>
</html>
